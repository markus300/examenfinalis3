<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>TP4</title>
    <script defer src="https://unpkg.com/alpinejs@3.10.2/dist/cdn.min.js"></script>
    <link rel="icon" type="image/x-icon" href="favicon.ico"> 
    <style media="screen">

      * {
        padding: 0;
        margin: 0;
      }

      .grilla-3 {
        display: grid;
        grid-template-columns: 33% 67% ;
      }

      .getAll {
      	background-color: yellow;
      	animation: cambio 3s infinite ease-in-out;
      	border-radius: 5px;
      	padding-left: 10px;
      	padding-top: 10px;
      	padding-bottom: 20px;
      	padding-right: 10px;
      }

      .text-center{
        text-align:center;
      }

      .row{
        border-top: 2px solid red;
      }

      #mensaje_error,
      #mensaje_error2 {
        color: red;
      }

      #formInSert, #formUpdate {
      	text-align: center;
      	padding: 20px 0;
      	line-height: 30px;
      }

      #formInSert {
      	background-color: #1bc51b;
      }

      #formUpdate {
      	background-color: yellow;
      }

      .btn {
      	display: inline-block;
      	font-weight: 400;
      	text-align: center;
      	white-space: nowrap;
      	vertical-align: middle;
      	-webkit-user-select: none;
      	-moz-user-select: none;
      	-ms-user-select: none;
      	user-select: none;
      	border: 1px solid transparent;
      	padding: .375rem .75rem;
      	font-size: 1rem;
      	line-height: 1.5;
      	border-radius: .25rem;
      	transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        margin: 20px 0;
      }

      @keyframes cambio {
        0% {
            box-shadow: 0px 0px 2px green;
            background: #c2c2c2;
        }
        50%{
            box-shadow: 0px 0px 10px darkgreen;
            background: #a6a6a6;
        }
        100%{
            box-shadow: 0px 0px 2px green;
            background: #c2c2c2;
        }
      }
    </style>
  </head>
  <body x-data="{
    resultados: [],
    update: false,
    init() {
      fetch('/user')
        .then(r => r.json())
        .then(resultados => {
          console.log(resultados);
          this.resultados = resultados.docs;
        })
        .catch(err => {
          console.log(err);
        });
    },
    addUser(e){
      e.preventDefault();
      const nombre = document.getElementById('nombre').value;
      const apellido = document.getElementById('apellido').value;
      const edad = document.getElementById('edad').value;
      const profesion = document.getElementById('profesion').value;
      const isadmin = document.getElementById('isadmin').checked;
      const errorBox = document.getElementById('mensaje_error');
      if (nombre.trim() == '' || apellido.trim() == ''|| edad.trim() == '' || profesion.trim() == '') {
        errorBox.innerText = 'El campo texto no puede estar vacio';
      }else{
        errorBox.innerText = '';
        const usuario = {
          nombre: nombre,
          apellido: apellido,
          edad: edad,
          profesion: profesion,
          isadmin: isadmin
        }
        addingUser(usuario).then(
          w => fetch('/user')
            .then(r => r.json())
            .then(resultados => {
              console.log(resultados);
              this.resultados = resultados.docs;
              document.getElementById('formInSert').reset();
            })
            .catch(err => {
              console.log(err);
            })
        );
      }
    },
    editUser(e, id){
      e.preventDefault();
      gettingUser(id);
    },
    saveChangesUser(e){
      e.preventDefault();
      const nombre = document.getElementById('nombreUPD').value;
      const apellido = document.getElementById('apellidoUPD').value;
      const edad = document.getElementById('edadUPD').value;
      const profesion = document.getElementById('profesionUPD').value;
      const isadmin = document.getElementById('isadminUPD').checked;
      const errorBox = document.getElementById('mensaje_error2');
      const idUser = document.getElementById('idUser').value;
      if (nombre.trim() == '' || apellido.trim() == ''|| edad.trim() == '' || profesion.trim() == '') {
        errorBox.innerText = 'El campo texto no puede estar vacio';
      }else{
        errorBox.innerText = '';
        const usuario = {
          nombre: nombre,
          apellido: apellido,
          edad: edad,
          profesion: profesion,
          isadmin: isadmin
        }
        editingUser(idUser, usuario).then(
          w => fetch('/user')
            .then(r => r.json())
            .then(resultados => {
              console.log(resultados);
              this.resultados = resultados.docs;
            })
            .catch(err => {
              console.log(err);
            })
        );
      }
    },
    delUser(e, id){
      e.preventDefault();
      deletingUser(id).then(
        w => fetch('/user')
          .then(r => r.json())
          .then(resultados => {
            console.log(resultados);
            this.resultados = resultados.docs;
          })
          .catch(err => {
            console.log(err);
          })
      );
    },
    cargaInicial(){
      fetch('/user')
        .then(r => r.json())
        .then(resultados => {
          console.log(resultados);
          this.resultados = resultados.docs;
        })
        .catch(err => {
          console.log(err);
        });
    }
  }" x-init="cargaInicial()">
    <div class="grilla-3">
      <div class="getAll">
        <h3 class="text-center">Todos los usuarios</h3>
        <template x-for="r in resultados" :key="r.id">
          <div class="row">
            <p x-text="`Nombre: ${r.name}`"></p>
            <p x-text="`Apellido: ${r.lastname}`"></p>
            <p x-text="`Edad: ${r.edad}`"></p>
            <p x-text="`Profesi√≥n: ${r.profesion}`"></p>
            <p x-text="`Fecha creada: ${r.createdAt}`"></p>
            <p x-text="`Privilegio de Administrador: ${r.isadmin}`"></p>
            <button type="button" name="button" @click="delUser($event, r.id)" class="btn">Borrar ‚ûñ</button>
            <button type="button" name="button" @click="editUser($event, r.id);update = !update" class="btn">Editar ‚úçÔ∏è</button>
          </div>
        </template>
      </div>
      <div class="insertOne">
        <form class="" id="formInSert" method="post">
          <h3>Agregar usuario</h3>
          <div class="">
            <label for="nombre">Nombre</label>
            <input type="text" name="nombre" value="" id="nombre">
          </div>
          <div class="">
            <label for="apellido">Apellido</label>
            <input type="text" name="apellido" value="" id="apellido">
          </div>
          <div class="">
            <label for="edad">Edad</label>
            <input type="text" name="edad" value="" id="edad">
          </div>
          <div class="">
            <label for="profesion">Profesi√≥n</label>
            <input type="text" name="profesion" value="" id="profesion">
          </div>
          <div class="">
            <label for="isadmin">Privilegio de Administrador </label>
            <input type="checkbox" name="isadmin" value="" id="isadmin">
          </div>
          <button type="button" name="button" @click="addUser($event)" class="btn">Agregar ‚ûï</button>
          <div id="mensaje_error"></div>
        </form>
        <div x-show="update" x-transition class="">
          <form class="" id="formUpdate" method="post">
            <h3>Editar usuario</h3>
            <div class="">
              <label for="nombreUPD">Nombre</label>
              <input type="text" name="nombre" value="" id="nombreUPD">
            </div>
            <div class="">
              <label for="apellido">Apellido</label>
              <input type="text" name="apellido" value="" id="apellidoUPD">
            </div>
            <div class="">
              <label for="edadUPD">Edad</label>
              <input type="text" name="edad" value="" id="edadUPD">
            </div>
            <div class="">
              <label for="profesionUPD">Profesi√≥n</label>
              <input type="text" name="profesion" value="" id="profesionUPD">
            </div>
            <div class="">
              <label for="isadminUPD">Privilegio de Administrador </label>
              <input type="checkbox" name="isadmin" value="" id="isadminUPD">
            </div>
            <input type="hidden" id="idUser" value="">
            <button type="button" name="button" @click="saveChangesUser($event)" class="btn">GUARDAR CAMBIOS üÜô</button>
            <button type="button" name="button" @click="update = !update" class="btn">CANCELAR üîô</button>
            <div id="mensaje_error2"></div>
          </form>
        </div>
      </div>
    </div>

  <script type="text/javascript">
    function data(){
      return {
        resultados: [],
        init() {
          fetch('/user')
            .then(r => r.json())
            .then(resultados => {
              console.log(resultados);
              this.resultados = resultados.docs;
            })
            .catch(err => {
              console.log(err);
            });
        },

        cargaInicial(){
          fetch('/user')
            .then(r => r.json())
            .then(resultados => {
              console.log(resultados);
              this.resultados = resultados.docs;
            })
            .catch(err => {
              console.log(err);
            });
        }
      }
    }

    const addingUser = async ({nombre, apellido,edad,profesion,isadmin}) => {

      const enviarFormulario = {
        name: nombre,
        lastname: apellido,
        edad: edad,
        profesion: profesion,
        isadmin: isadmin
      };

      let formBody = [];
      for (var propiedad in enviarFormulario) {
        if (enviarFormulario.hasOwnProperty(propiedad)) {
          let encodedKey = encodeURIComponent(propiedad);
          let encodedValue = encodeURIComponent(enviarFormulario[propiedad]);
          formBody.push(encodedKey + "=" + encodedValue);
        }
      }
      formBody = formBody.join("&");
      const result = await fetch(
        '/user',
        {
          method: 'POST',
          headers: {
            Accept: "application/json",
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: formBody,
        }
      );
      const rjson = await result.json();
      console.log(rjson);
    }
    const deletingUser = async (id) => {
      const url = `user/${id}`;
      const formBody = ``;
      const result = await fetch(
        url,
        {
          method: 'DELETE',
          headers: {
            Accept: "application/json",
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: formBody,
        }
      );
      const rjson = await result.json();
      console.log(rjson);
    }
    const editingUser = async (id, {nombre, apellido,edad,profesion,isadmin}) => {
      const url = `user/${id}`;
      //const formBody = ``;
      const enviarFormulario = {
        name: nombre,
        lastname: apellido,
        edad: edad,
        profesion: profesion,
        isadmin: isadmin
      };
      let formBody = [];
      for (var propiedad in enviarFormulario) {
        if (enviarFormulario.hasOwnProperty(propiedad)) {
          let encodedKey = encodeURIComponent(propiedad);
          let encodedValue = encodeURIComponent(enviarFormulario[propiedad]);
          formBody.push(encodedKey + "=" + encodedValue);
        }
      }
      formBody = formBody.join("&");
      const result = await fetch(
        url,
        {
          method: 'PUT',
          headers: {
            Accept: "application/json",
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: formBody,
        }
      );
      const rjson = await result.json();
      console.log(rjson);
    }

    const gettingUser = async (id) => {
      const url = `user/${id}`;
      const result = await fetch(
        url,
        {
          method: 'GET',
          headers: {
            Accept: "application/json",
            "Content-Type": "application/x-www-form-urlencoded",
          }
        }
      );
      const rjson = await result.json();
      console.log(rjson);
      const nombreUPD = document.getElementById('nombreUPD');
      const apellidoUPD = document.getElementById('apellidoUPD');
      const edadUPD = document.getElementById('edadUPD');
      const profesionUPD = document.getElementById('profesionUPD');
      const idUser = document.getElementById('idUser');
      nombreUPD.value = rjson.docs[0].name;
      apellidoUPD.value = rjson.docs[0].lastname;
      edadUPD.value = rjson.docs[0].edad;
      profesionUPD.value = rjson.docs[0].profesion;
      idUser.value = rjson.docs[0].id;
    }
  </script>
  </body>
</html>
