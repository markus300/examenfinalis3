<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Twitter Clone - Final</title>
    <link rel="stylesheet" href="styles.css" />
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
      crossorigin="anonymous"
    />
    <style>
      button {
        cursor: pointer;
        border: none;
        background: none;
      }

      .faved{
        color: red;
      }

      #mensaje_error {
        color: red;
      }

      #principal {
        width: 640px;
      }
    </style>
  </head>
  <body>
    <!-- https://somanath-goudar.github.io/html-css-projects/twitter-clone/ -->
    <!-- sidebar starts -->
    <div class="sidebar">
      <i class="fab fa-twitter"></i>
      <div class="sidebarOption active">
        <span class="material-icons"> home </span>
        <h2>Home</h2>
      </div>

      <div class="sidebarOption">
        <span class="material-icons"> search </span>
        <h2>Explore</h2>
      </div>

      <div class="sidebarOption">
        <span class="material-icons"> notifications_none </span>
        <h2>Notifications</h2>
      </div>

      <div class="sidebarOption">
        <span class="material-icons"> mail_outline </span>
        <h2>Messages</h2>
      </div>

      <div class="sidebarOption">
        <span class="material-icons"> bookmark_border </span>
        <h2>Bookmarks</h2>
      </div>

      <div class="sidebarOption">
        <span class="material-icons"> list_alt </span>
        <h2>Lists</h2>
      </div>

      <div class="sidebarOption">
        <span class="material-icons"> perm_identity </span>
        <h2>Profile</h2>
      </div>

      <div class="sidebarOption">
        <span class="material-icons"> more_horiz </span>
        <h2>More</h2>
      </div>
      <button class="sidebar__tweet">Tweet</button>
    </div>
    <!-- sidebar ends -->

    <!-- feed starts -->
    <div class="feed" x-data="feed()">
      <div class="feed__header">
        <h2>Home</h2>
      </div>

      <!-- tweetbox starts -->
      <div class="tweetBox">
        <form action="POST" method="#" @submit.prevent="postTweet()">
          <div class="tweetbox__input">
            <img
              src="https://i.pravatar.cc/150?img=7"
              alt=""
            />
            <input type="text" placeholder="What's happening?" id="que_pasa" x-ref="campotexto" @input="texto = $event.target.value"/>
          </div>
          <button class="tweetBox__tweetButton">Tweet</button>
          <div id="mensaje_error" x-show="err != ''" x-text="err"></div>
        </form>
      </div>
      <!-- tweetbox ends -->

      <div id="principal">
        <template x-for="tweet in tweets">
          <template x-if="tweet !== undefined">
            <div class="post" x-show="tweet.nombre !== ''" x-transition:enter="">
              <div class="post__avatar">
                <img
                  :src="tweet.avatar"
                  :alt="tweet.nombre"
                />
              </div>

              <div class="post__body" :idt="tweet.idt">
                <div class="post__header">
                  <div class="post__headerText">
                    <h3><span x-text="tweet.nombre"></span> <span class="post__headerSpecial" x-text="tweet.usuario"><span class="material-icons post__badge"> verified </span></span></h3>
                  </div>
                  <div class="post__headerDescription">
                    <p x-text="tweet.comentario"></p>
                  </div>
                </div>
                <template x-if="tweet.imagen != undefined">
                  <img
                    :src="tweet.imagen"
                    :alt="tweet.comentario"
                  />
                </template>
                <div class="post__footer">
                  <span x-text="tweet.cantretweet"></span><button :class="{'material-icons rt faved': tweet.retweet, 'material-icons rt': !tweet.retweet}" @click="retweet(tweet)"> repeat </button>
                  <span x-text="tweet.cantfavorito"></span>
                  <button :class="{'material-icons fav faved': tweet.favorito, 'material-icons fav': !tweet.favorito}" @click="fave(tweet)">favorite_border</button>
                  <button class="material-icons"> publish </button>
                </div>
              </div>
            </div>   <!-- Fin de un tweet  -->
          </template>
        </template>

      </div> <!-- Fin de principal -->

    </div> <!-- Fin de  feed  -->

    <!-- widgets starts -->
    <div class="widgets">
      <div class="widgets__input">
        <span class="material-icons widgets__searchIcon"> search </span>
        <input type="text" placeholder="Search Twitter" />
      </div>

      <div class="widgets__widgetContainer">
        <h2>What's happening?</h2>
        <blockquote class="twitter-tweet">
          <p lang="en" dir="ltr">
            Sunsets don&#39;t get much better than this one over
            <a href="https://twitter.com/GrandTetonNPS?ref_src=twsrc%5Etfw">@GrandTetonNPS</a>.
            <a href="https://twitter.com/hashtag/nature?src=hash&amp;ref_src=twsrc%5Etfw"
              >#nature</a
            >
            <a href="https://twitter.com/hashtag/sunset?src=hash&amp;ref_src=twsrc%5Etfw"
              >#sunset</a
            >
            <a href="http://t.co/YuKy2rcjyU">pic.twitter.com/YuKy2rcjyU</a>
          </p>
          &mdash; US Department of the Interior (@Interior)
          <a href="https://twitter.com/Interior/status/463440424141459456?ref_src=twsrc%5Etfw"
            >May 5, 2014</a
          >
        </blockquote>
        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      </div>
    </div>
    <!-- widgets ends -->
    <script>
      function feed() {
        return {
          tweets: [],
          err: '',
          feedErr: null,
          texto: '',
          fave(tweet) {
            if (tweet.favorito) {
              tweet.favorito = false
              tweet.cantfavorito = tweet.cantfavorito - 1
              this.favoriting(tweet.idt, tweet);
            } else {
              tweet.favorito = true
              tweet.cantfavorito = tweet.cantfavorito + 1
              this.favoriting(tweet.idt, tweet);
            }
          },
          retweet(tweet){
            if (tweet.retweet) {
              tweet.retweet = false
              tweet.cantretweet = tweet.cantretweet - 1
              this.favoriting(tweet.idt, tweet);
            }
            else{
              tweet.retweet = true
              tweet.cantretweet = tweet.cantretweet + 1
              this.favoriting(tweet.idt, tweet);
            }
          },
          async favoriting(id, {favorito, retweet, cantfavorito,cantretweet}) {
            const url = `tweets/${id}`;
            //const formBody = ``;
            const enviarFormulario = {
              favorito: favorito,
              retweet: retweet,
              cantfavorito: cantfavorito,
              cantretweet: cantretweet
            };
            let formBody = [];
            for (var propiedad in enviarFormulario) {
              if (enviarFormulario.hasOwnProperty(propiedad)) {
                let encodedKey = encodeURIComponent(propiedad);
                let encodedValue = encodeURIComponent(enviarFormulario[propiedad]);
                formBody.push(encodedKey + "=" + encodedValue);
              }
            }
            formBody = formBody.join("&");
            const result = await fetch(
              url,
              {
                method: 'PUT',
                headers: {
                  Accept: "application/json",
                  "Content-Type": "application/x-www-form-urlencoded",
                },
                body: formBody,
              }
            );
            const rjson = await result.json();
            console.log(rjson);
          },
          postTweet() {
            if (this.texto !== '') {
              var post = {
                usuario: '@jazkus',
                nombre: 'Jazmin|Markus',
                avatar: 'https://i.pravatar.cc/150?img=7',
                comentario: this.texto,
                favorito: false,
                cantfavorito: 0,
                retweet: false,
                cantretweet: 0
                //id: Math.floor(Math.random()*100000)
              }
              this.err = ''
              this.tweets.unshift(post)
              this.postingTweets(post);
              document.getElementById("que_pasa").value = ''
              this.texto = ''
            } else {
              this.err = 'No hay texto que postear'
              document.getElementById("que_pasa").value = ''
              this.texto = ''
            }
          },
          async postingTweets({usuario,nombre,avatar,comentario,favorito,cantfavorito,retweet, cantretweet}){
              const enviarFormulario = {
                usuario: usuario,
                nombre: nombre,
                avatar: avatar,
                comentario: comentario,
                favorito: favorito,
                cantfavorito: cantfavorito,
                retweet: retweet,
                cantretweet: cantretweet
              };

              let formBody = [];
              for (var propiedad in enviarFormulario) {
                if (enviarFormulario.hasOwnProperty(propiedad)) {
                  let encodedKey = encodeURIComponent(propiedad);
                  let encodedValue = encodeURIComponent(enviarFormulario[propiedad]);
                  formBody.push(encodedKey + "=" + encodedValue);
                }
              }
              formBody = formBody.join("&");
              const result = await fetch(
                '/tweets',
                {
                  method: 'POST',
                  headers: {
                    Accept: "application/json",
                    "Content-Type": "application/x-www-form-urlencoded",
                  },
                  body: formBody,
                }
              );
              const rjson = await result.json();
              console.log(rjson);

          },
          getTweets() {
            // https://a75303d9-b8c8-47c4-a442-eafc9ccec2db.mock.pstmn.io/tweets
            fetch('/tweets')
            .then(response => {
              if (!response.ok) {
                this.feedErr = 'Hubo un problema en el request'
                throw new Error ('Hubo un problema en el request')
              }
              return response.json()
            })
            .then(data => {
              console.log('data? ',data.docs);
              const result = data.docs;
              for (var propiedad in result) {
                console.log('debe aparecer', result[propiedad]);
                this.tweets.push(result[propiedad])
              }
              console.log('this.tweets', this.tweets);
              /*
              data.resultados.forEach(resultado => {
                resultado.faved = false;
                this.tweets.push(resultado)
              });
              */

            })
            .catch(error => {
              this.feedErr = error
              console.error('Hubo un problema con la operaci√≥n', error)
            });
          },
          init() {
            this.getTweets()
          }
        }
      }
    </script>
  </body>
</html>
